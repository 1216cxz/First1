import streamlit as st
import pandas as pd

# 제목
st.title("2025년 5월 연령별 인구 현황 분석")

# 데이터 불러오기
uploaded_file = st.file_uploader("CSV 파일 업로드 (EUC-KR 인코딩)", type="csv")

if uploaded_file is not None:
    # 데이터 읽기
    df = pd.read_csv(uploaded_file, encoding="EUC-KR")

    # 열 이름 전처리
    original_columns = df.columns.tolist()
    age_columns = [col for col in original_columns if col.startswith("2025년05월_계_")]
    df = df.rename(columns={col: col.replace("2025년05월_계_", "") for col in age_columns})

    # '총인구수' 컬럼이 존재하면 이름 유지, 없다면 추정
    if '총인구수' not in df.columns:
        df['총인구수'] = df[[col for col in df.columns if col.isdigit()]].sum(axis=1)

    # 총인구수 기준 상위 5개 행정구역 추출
    df_top5 = df.nlargest(5, '총인구수')

    # 연령 컬럼만 선택 (숫자인 컬럼만)
    age_cols = [col for col in df.columns if col.isdigit()]

    st.subheader("📊 원본 데이터 (일부 미리보기)")
    st.dataframe(df.head())

    st.subheader("👑 총인구수 기준 상위 5개 지역")
    st.dataframe(df_top5[['행정구역', '총인구수']])

    st.subheader("📈 연령별 인구 선 그래프 (상위 5개 지역)")

    # 그래프 시각화 (각 행정구역별로 차트 그리기)
    for idx, row in df_top5.iterrows():
        st.markdown(f"#### 📍 {row['행정구역']}")
        age_data = pd.DataFrame({
            "연령": list(map(int, age_cols)),
            "인구수": row[age_cols].astype(int).values
        }).set_index("연령")

        st.line_chart(age_data)

else:
    st.info("왼쪽 사이드바 또는 위에서 CSV 파일을 업로드해주세요.")
